name: GitHub Pages

on:
  push:
    branches:
      - docs


jobs:
  deploy:
    runs-on: ubuntu-latest
    env:
      PROJECT_NAME: cookbook网站
    concurrency:
      group: ${{ github.workflow }}-${{ github.ref }}
    steps:
      - name: Checkout
        uses: actions/checkout@v3
        with:
          submodules: true
          fetch-depth: 0
      
      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v2
        with:
          hugo-version: "latest"
          extended: true
      
      - name: Build
        run: hugo --minify
      
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v3
        with: 
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
          publish_branch: main
          commit_message: ${{ github.event.head_commit.message }}

      - name: Notify Success
        uses: leafney/dingtalk-action@v1
        if: always()
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        with:
          msgtype: text
          notify_when: 'success'
          text: '[${{ env.PROJECT_NAME }}] 发布成功'

      - name: Notify Failure
        uses: leafney/dingtalk-action@v1
        if: always()
        env:
          DINGTALK_ACCESS_TOKEN: ${{ secrets.DINGTALK_ACCESS_TOKEN }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        with:
          msgtype: markdown
          notify_when: 'failure'
          title: '[${{ env.PROJECT_NAME }}] 发布失败'
          text: |
            Action **[${{ github.workflow }}]** 发布失败

            [查看错误信息](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})